# Maintainer (original): jeffshee - https://github.com/jeffshee
# Modified by: Leonardo Berbert <leo4berbert@gmail.com>

pkgname=gnome-ext-hanabi
pkgdesc="Hanabi video wallpaper extension for GNOME"
depends=('gnome-shell' 'curl' 'xdg-utils' 'unzip' 'meson')
makedepends=('git')
pkgver=$(date +%y.%m.%d)
pkgrel=$(date +%H%M)
arch=('any')
license=('MIT')
url="https://github.com/communitybig/${pkgname}"
source=()
md5sums=()

# Automatically detect and use the correct install file
if [ -e "${pkgname}.install" ]; then
    install=${pkgname}.install
elif [ -e "pkgbuild.install" ]; then
    install=pkgbuild.install
fi

prepare() {
    # Detect GNOME version and select the appropriate branch
    local gnome_version
    gnome_version=$(gnome-shell --version | awk '{print $3}' | cut -d'.' -f1)

    if (( gnome_version >= 47 )); then
        branch="gnome-47"
    elif (( gnome_version >= 45 )); then
        branch="main"
    else
        branch="legacy"
    fi

    msg "Detected GNOME version: $gnome_version, using branch: $branch"

    # Clone the appropriate branch from the original repo
    git clone --branch "$branch" "https://github.com/jeffshee/${pkgname}.git" "${srcdir}/${pkgname}"
}

build() {
    cd "${srcdir}/${pkgname}"
    ./run.sh install
    # Copiar os arquivos corretos para a pasta de instalação
    mkdir -p "${srcdir}/extension"
    cp -r src res metadata.json "${srcdir}/extension"
}
check() {
    cd "${srcdir}/${pkgname}"
    # No specific check/test steps provided by the source
}

package() {
    install -dm755 "${pkgdir}/usr/share/gnome-shell/extensions/hanabi-extension@jeffshee.github.io"
    cp -r "${srcdir}/extension/"* "${pkgdir}/usr/share/gnome-shell/extensions/hanabi-extension@jeffshee.github.io/"
    
    # Instalar a licença
    if [ -f "LICENSE" ]; then
        install -Dm644 LICENSE "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
    fi

    # Instalar a documentação
    if [ -f "README.md" ]; then
        install -Dm644 README.md "${pkgdir}/usr/share/doc/${pkgname}/README.md"
    fi
}